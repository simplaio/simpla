!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.SimplaElement=e()}(this,function(){"use strict";function t(t,e,i){t.dispatchEvent(new CustomEvent(e+"-changed",{detail:{value:i}}))}var e={NO_SIMPLA:"Cannot find Simpla, ensure it is included before this component"};return function(i){return function(i){function a(){var t=this;if(i.call(this),!window.Simpla)throw new Error(e.NO_SIMPLA);this._loaded=!1,this.__simplaObservers={},this.__triggerBufferSync=function(){t.loaded&&t._protectedSetCallback()}}i&&(a.__proto__=i),(a.prototype=Object.create(i&&i.prototype)).constructor=a;var o={path:{configurable:!0},editable:{configurable:!0},readonly:{configurable:!0},loaded:{configurable:!0},_loaded:{configurable:!0}},n={observedAttributes:{configurable:!0}};return o.path.get=function(){return this.__path},o.path.set=function(t){var e=this.__path;this.__path=t,t!==e&&this._initPathIfReady(t)},o.editable.get=function(){return this.__editable},o.editable.set=function(e){var i=this.__editable;this.readonly||(this.__editable=e,e!==i&&t(this,"editable",e))},o.readonly.get=function(){return this.__readonly},o.readonly.set=function(t){var e=this.__readonly;this.__readonly=!1,t||!0!==e?t&&(this.editable=!1):this.editable=Simpla.getState("editable"),this.__readonly=t},o.loaded.get=function(){return this.__loaded},o._loaded.set=function(e){var i=this.__loaded;this.__loaded=e,e!==i&&t(this,"loaded",e)},n.observedAttributes.get=function(){return["path","editable","readonly","loaded"]},a.prototype.attributeChangedCallback=function(t,e,i){"path"===t?this.path=i:this[t]=null!==i},a.prototype.connectedCallback=function(){var t=this,e=this.constructor.simplaConfig.events;i.prototype.connectedCallback&&i.prototype.connectedCallback.call(this),e.forEach(function(e){return t.addEventListener(e,t.__triggerBufferSync)}),this.editable=!this.readonly&&(this.editable||Simpla.getState("editable")),this._observeSimplaEditable(),this._initPathIfReady(this.path)},a.prototype.disconnectedCallback=function(){var t=this,e=this.constructor.simplaConfig.events;i.prototype.disconnectedCallback&&i.prototype.disconnectedCallback.call(this),e.forEach(function(e){return t.removeEventListener(e,t.__triggerBufferSync)}),Object.keys(this.__simplaObservers).forEach(function(e){t.__simplaObservers[e].unobserve()}),this.__simplaObservers={}},a.prototype._initPathIfReady=function(t){this.isConnected&&void 0!==t&&this._initSimplaPath(t)},a.prototype._initSimplaPath=function(t){var e=this;this._loaded=!1,Simpla.get(t).then(function(i){var a=!(i&&i.data),o=e.path!==t,n=Simpla.getState("buffer"),r=n&&n[t]&&!n[t].modified;o||(a&&r?e._protectedSetCallback():e._protectedGetCallback(i),e._loaded=!0)}),this._observeSimplaBuffer(t)},a.prototype._observeSimplaBuffer=function(t){var e=this,i=this.__simplaObservers;t&&(i.buffer&&i.buffer.unobserve(),i.buffer=Simpla.observe(t,function(t){t&&t.data&&e._protectedGetCallback(t)}))},a.prototype.updateSimplaBuffer=function(){var t=this;return this.constructor.simplaConfig.dataProperties.reduce(function(e,i){return Object.assign(e,(a={},a[i]=t[i],a));var a},{})},a.prototype.updateFromSimpla=function(t){Object.assign(this,t.data)},a.prototype._protectedGetCallback=function(t){this.__loadingFromSimpla=!0,this.updateFromSimpla(t),this.__loadingFromSimpla=!1},a.prototype._protectedSetCallback=function(){if(!this.__loadingFromSimpla&&this.isConnected&&this.path){var t=this.updateSimplaBuffer(),e=this.constructor.simplaConfig.type;void 0===t&&null!==t||Simpla.set(this.path,{type:e,data:t})}},a.prototype._observeSimplaEditable=function(){var t=this,e=this.__simplaObservers;e.editable&&e.editable.unobserve(),e.editable=Simpla.observeState("editable",function(e){t.editable=e})},Object.defineProperties(a.prototype,o),Object.defineProperties(a,n),a}(i)}});
